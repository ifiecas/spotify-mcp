name: Build -> Push to ACR -> Update Web App

on:
  push:
    branches: [ main ]   # change if your working branch differs

env:
  ACR_NAME: spotifymcpracr
  IMAGE_NAME: spotify-mcp
  IMAGE_TAG: latest
  WEBAPP_NAME: spotify-mcp-ivy
  RESOURCE_GROUP: spotify-mcp-rg

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Login to ACR using Admin credentials (you enabled them)
      - name: Docker login to ACR (admin)
        run: |
          echo "${{ secrets.ACR_PASSWORD }}" | docker login ${{ env.ACR_NAME }}.azurecr.io \
            -u "${{ secrets.ACR_USERNAME }}" --password-stdin

      - name: Build image
        run: docker build -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} .

      - name: Push image
        run: docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

  configure-webapp:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      # Login to Azure to configure the Web App
      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}  # service principal JSON with Contributor on RG

      - name: Point Web App to ACR image & restart
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az webapp config container set \
              --name ${{ env.WEBAPP_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --docker-custom-image-name ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
              --docker-registry-server-url https://${{ env.ACR_NAME }}.azurecr.io

            az webapp restart \
              --name ${{ env.WEBAPP_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }}
